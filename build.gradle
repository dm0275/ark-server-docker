/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.4.2/samples
 */


def currentDate = new Date().format('yyyy.MM.dd')

ext {
  dataDir = "$rootDir/data"
  qname = "dm0275/ark-server"
  dateTag = "${qname}:${currentDate}"
  latestTag = "${qname}:latest"
  serverName = System.getenv("SERVER_NAME") ?: "ark"
  serverMap = System.getenv("SERVER_MAP") ?: "TheIsland"
  joinPassword = System.getenv("JOIN_PASSWORD") ?: "changeme"
  adminPassword = System.getenv("ADMIN_PASSWORD") ?: "changeme"
  serverDirs = [
    "serverDir": "${dataDir}/${serverName}",
    "modsDir": "${dataDir}/${serverName}_mods"
  ]
  envVars = [
    SERVER_MAP: serverMap,
    SERVER_NAME: serverName,
    JOIN_PASSWORD: joinPassword,
    ADMIN_PASSWORD: joinPassword,
    ARK_HOME: serverDirs['serverDir'],
    ARK_MODS: serverDirs['modsDir'],
  ]
}

task dockerLogin(type: Exec) {
  commandLine "bash", "-c",  """printenv DOCKER_TOKEN \
    | docker login -u "\$DOCKER_USERNAME" --password-stdin"""
}

task setup() {
  group "Ark"
  description "Setup the Ark directories"
  doLast {
    serverDirs.keySet().forEach { key ->
      mkdir(serverDirs[key])
    }
  }
}

task build(type: Exec) {
  group "Ark"
  description "Build Ark server image"
  String buildCmd = """docker build \
            -t ${dateTag} \
            -t ${latestTag}"""
  commandLine "${buildCmd} .".tokenize()
}

task buildNoCache(type: Exec) {
  group "Ark"
  description "Build Ark server image"
  String buildCmd = """docker build --no-cache \
            -t ${dateTag} \
            -t ${latestTag}"""
  commandLine "${buildCmd} .".tokenize()
}

task push(type: Exec) {
  group "Ark"
  description "Push Ark server image"
  commandLine "bash", "-c", """docker push ${dateTag} \
            && docker push ${latestTag}"""

}

task run(type: Exec) {
  group "Ark"
  description "Run Ark server"
  environment envVars
  commandLine "docker-compose up -d".tokenize()
}

task stop(type: Exec) {
  group "Ark"
  description "Stop Ark server"
  environment envVars
  commandLine "docker-compose down -v".tokenize()
}